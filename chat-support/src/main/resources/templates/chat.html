<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - [[${roomId}]]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .chat-container {
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chat-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .users-sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #dee2e6;
            padding: 1rem;
        }
        
        .messages-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .messages-area {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 10px;
            max-width: 70%;
            animation: fadeIn 0.3s ease-in;
        }
        
        .message.own {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.other {
            background: #f1f3f4;
            color: #333;
        }
        
        .message.system {
            background: #e3f2fd;
            color: #1976d2;
            text-align: center;
            margin: 0.5rem auto;
            max-width: 50%;
            font-style: italic;
        }
        
        .message-header {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 0.25rem;
        }
        
        .message-content {
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }
        
        .input-area {
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        
        .typing-indicator {
            padding: 0.5rem 1rem;
            font-style: italic;
            color: #6c757d;
            font-size: 0.9rem;
            min-height: 2rem;
        }
        
        .online-user {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .online-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .typing-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6c757d;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        <i class="fas fa-comments"></i> 
                        Phòng: <span th:text="${roomId}"></span>
                    </h5>
                    <small>Chào mừng <strong th:text="${username}"></strong>!</small>
                </div>
                <div>
                    <button class="btn btn-light btn-sm me-2" onclick="toggleUsersList()">
                        <i class="fas fa-users"></i> <span id="usersCount">0</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="leaveRoom()">
                        <i class="fas fa-sign-out-alt"></i> Thoát
                    </button>
                </div>
            </div>
        </div>
        
        <div class="chat-body">
            <!-- Users sidebar -->
            <div class="users-sidebar" id="usersSidebar">
                <h6><i class="fas fa-users"></i> Đang online</h6>
                <div id="usersList">
                    <!-- Users will be populated here -->
                </div>
            </div>
            
            <!-- Messages area -->
            <div class="messages-container">
                <div class="messages-area" id="messagesArea">
                    <!-- Recent messages -->
                    <div th:each="message : ${recentMessages}" class="message system" th:if="${message.type.name() == 'JOIN' or message.type.name() == 'LEAVE'}">
                        <div class="message-content" th:text="${message.content}"></div>
                        <div class="message-time" th:text="${#temporals.format(message.timestamp, 'HH:mm')}"></div>
                    </div>
                    <div th:each="message : ${recentMessages}" 
                         th:class="${message.sender == username} ? 'message own' : 'message other'"
                         th:if="${message.type.name() == 'CHAT'}">
                        <div class="message-header" th:unless="${message.sender == username}" th:text="${message.sender}"></div>
                        <div class="message-content" th:text="${message.content}"></div>
                        <div class="message-time" th:text="${#temporals.format(message.timestamp, 'HH:mm')}"></div>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator"></div>
                
                <!-- Input area -->
                <div class="input-area">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" 
                               placeholder="Nhập tin nhắn của bạn..." maxlength="500">
                        <button class="btn btn-primary" type="button" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <small class="text-muted">Nhấn Enter để gửi tin nhắn</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden values -->
    <input type="hidden" id="username" th:value="${username}">
    <input type="hidden" id="roomId" th:value="${roomId}">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <script>
        const username = document.getElementById('username').value;
        const roomId = document.getElementById('roomId').value;
        
        let stompClient = null;
        let isConnected = false;
        let typingTimeout = null;
        let connectedUsers = new Set();

        // Kết nối WebSocket
        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                isConnected = true;
                
                // Subscribe to public messages
                stompClient.subscribe('/topic/public/' + roomId, function(message) {
                    showMessage(JSON.parse(message.body));
                });
                
                // Subscribe to typing notifications
                stompClient.subscribe('/topic/typing/' + roomId, function(message) {
                    showTyping(JSON.parse(message.body));
                });
                
                // Subscribe to private messages
                stompClient.subscribe('/user/queue/private', function(message) {
                    showMessage(JSON.parse(message.body));
                });
                
                // Add user to room
                addUser();
            }, function(error) {
                console.error('WebSocket connection error:', error);
                setTimeout(connect, 5000); // Retry connection
            });
        }

        // Thêm user vào room
        function addUser() {
            if (stompClient && isConnected) {
                const chatMessage = {
                    sender: username,
                    type: 'JOIN'
                };
                stompClient.send('/app/chat.addUser/' + roomId, {}, JSON.stringify(chatMessage));
            }
        }

        // Gửi tin nhắn
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (content && stompClient && isConnected) {
                const chatMessage = {
                    sender: username,
                    content: content,
                    type: 'CHAT'
                };
                
                stompClient.send('/app/chat.sendMessage/' + roomId, {}, JSON.stringify(chatMessage));
                messageInput.value = '';
            }
        }

        // Hiển thị tin nhắn
        function showMessage(message) {
            const messagesArea = document.getElementById('messagesArea');
            const messageElement = document.createElement('div');
            
            if (message.type === 'JOIN' || message.type === 'LEAVE') {
                messageElement.className = 'message system';
                messageElement.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${formatTime(new Date())}</div>
                `;
                
                // Update user list
                if (message.type === 'JOIN') {
                    connectedUsers.add(message.sender);
                } else {
                    connectedUsers.delete(message.sender);
                }
                updateUsersList();
                
            } else if (message.type === 'CHAT') {
                messageElement.className = message.sender === username ? 'message own' : 'message other';
                messageElement.innerHTML = `
                    ${message.sender !== username ? `<div class="message-header">${message.sender}</div>` : ''}
                    <div class="message-content">${escapeHtml(message.content)}</div>
                    <div class="message-time">${formatTime(new Date())}</div>
                `;
            }
            
            messagesArea.appendChild(messageElement);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Xử lý typing indicator
        function showTyping(message) {
            if (message.sender !== username) {
                const typingIndicator = document.getElementById('typingIndicator');
                typingIndicator.innerHTML = `${message.sender} đang gõ <span class="typing-dots"><span></span><span></span><span></span></span>`;
                
                setTimeout(() => {
                    typingIndicator.innerHTML = '';
                }, 3000);
            }
        }

        // Gửi thông báo typing
        function sendTyping() {
            if (stompClient && isConnected) {
                const typingMessage = {
                    sender: username,
                    type: 'TYPING'
                };
                stompClient.send('/app/chat.typing/' + roomId, {}, JSON.stringify(typingMessage));
            }
        }

        // Cập nhật danh sách users
        function updateUsersList() {
            const usersList = document.getElementById('usersList');
            const usersCount = document.getElementById('usersCount');
            
            usersList.innerHTML = '';
            connectedUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'online-user';
                userElement.innerHTML = `
                    <div class="online-dot"></div>
                    <span>${user}</span>
                `;
                usersList.appendChild(userElement);
            });
            
            usersCount.textContent = connectedUsers.size;
        }

        // Toggle users sidebar
        function toggleUsersList() {
            const sidebar = document.getElementById('usersSidebar');
            sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
        }

        // Rời phòng
        function leaveRoom() {
            if (stompClient && isConnected) {
                stompClient.disconnect();
            }
            window.location.href = '/';
        }

        // Utility functions
        function formatTime(date) {
            return date.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Event listeners
        document.getElementById('messageInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            } else {
                // Send typing notification
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(sendTyping, 300);
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (stompClient && isConnected) {
                stompClient.disconnect();
            }
        });

        // Initialize
        connect();
        document.getElementById('messageInput').focus();
    </script>
</body>
</html>